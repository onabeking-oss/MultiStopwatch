<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マルチストップウォッチ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
            touch-action: manipulation; /* スマホでのダブルタップ拡大防止 */
            padding-bottom: 80px; /* FABのための余白 */
        }
        
        .timer-font {
            font-family: 'Roboto Mono', monospace;
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }

        /* モバイルでの操作性を向上させるためのスタイル */
        .btn-action {
            transition: all 0.1s;
        }
        .btn-action:active {
            transform: scale(0.95);
        }
        
        /* カードのアニメーション */
        .member-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .member-card.removing {
            opacity: 0;
            transform: scale(0.9);
            margin-bottom: -100px; /* 詰める動きをスムーズに */
        }
        
        /* スクロールバーのカスタマイズ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800 relative">

    <!-- ヘッダー -->
    <header class="bg-blue-600 text-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold flex items-center gap-2">
                <i data-lucide="timer"></i> マルチストップウォッチ
            </h1>
            <div class="text-sm hidden md:block opacity-90">複数人のタイムを同時に管理</div>
        </div>
        
        <!-- 全体コントロール -->
        <div class="bg-blue-700 py-3 px-4 shadow-inner">
            <div class="container mx-auto flex flex-wrap gap-3 justify-center md:justify-start">
                <button onclick="startAll()" class="btn-action bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded shadow flex items-center gap-2 flex-1 md:flex-none justify-center">
                    <i data-lucide="play"></i> 全員スタート
                </button>
                <button onclick="stopAll()" class="btn-action bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded shadow flex items-center gap-2 flex-1 md:flex-none justify-center">
                    <i data-lucide="square"></i> 全員ストップ
                </button>
                <button onclick="resetAll()" class="btn-action bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded shadow flex items-center gap-2 flex-1 md:flex-none justify-center">
                    <i data-lucide="rotate-ccw"></i> 全員リセット
                </button>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="flex-grow container mx-auto px-2 py-6">
        
        <!-- 設定エリア -->
        <div class="bg-white rounded-lg p-4 mb-6 flex flex-wrap items-center justify-between shadow-sm border border-gray-200 gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-blue-100 p-2 rounded-full text-blue-600">
                    <i data-lucide="users" class="w-5 h-5"></i>
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-bold text-gray-700 text-sm md:text-base">初期人数設定:</span>
                    <input type="number" id="init-count" value="10" min="1" max="50" class="w-20 p-2 rounded border border-gray-300 text-center font-bold text-gray-800 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <span class="text-sm text-gray-600">人</span>
                </div>
            </div>
            <button onclick="resetWithCount()" class="w-full md:w-auto bg-gray-50 hover:bg-red-50 text-gray-700 hover:text-red-600 border border-gray-300 hover:border-red-300 font-bold py-2 px-4 rounded shadow-sm text-sm flex items-center justify-center gap-2 transition btn-action">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> 設定して再生成
            </button>
        </div>

        <!-- メンバーリストと追加ボタンを含むグリッド -->
        <div id="members-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
            <!-- JavaScriptでここにメンバーカードが生成されます -->
            
            <!-- カード型の追加ボタン（リストの最後に表示） -->
            <button onclick="addMember()" class="member-card bg-gray-100 border-2 border-dashed border-gray-300 hover:border-blue-400 hover:bg-blue-50 text-gray-400 hover:text-blue-500 rounded-lg min-h-[180px] flex flex-col items-center justify-center gap-2 transition-all duration-200 group btn-action" id="add-card-btn">
                <div class="bg-white p-3 rounded-full shadow-sm group-hover:scale-110 transition-transform">
                    <i data-lucide="plus" class="w-8 h-8"></i>
                </div>
                <span class="font-bold text-sm">メンバーを追加</span>
            </button>
        </div>

        <!-- 集計エリア -->
        <div class="bg-white rounded-xl shadow-lg p-6 max-w-4xl mx-auto border border-gray-200 mt-8">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-700 flex items-center gap-2">
                    <i data-lucide="clipboard-list"></i> 結果一覧
                </h2>
                <div class="flex gap-2">
                    <button onclick="generateReport()" class="bg-blue-100 text-blue-700 hover:bg-blue-200 px-4 py-2 rounded font-medium text-sm transition">
                        更新
                    </button>
                    <button onclick="copyReport()" class="bg-indigo-600 text-white hover:bg-indigo-700 px-4 py-2 rounded font-medium text-sm flex items-center gap-2 shadow transition">
                        <i data-lucide="copy"></i> コピー
                    </button>
                </div>
            </div>
            <textarea id="report-area" class="w-full h-48 p-4 bg-gray-50 border border-gray-300 rounded-lg timer-font text-sm leading-relaxed focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" readonly placeholder="「更新」ボタンを押すと、現在のタイム一覧が表示されます。"></textarea>
            <p id="copy-message" class="text-green-600 text-sm mt-2 font-bold h-5 opacity-0 transition-opacity text-center"></p>
        </div>

    </main>

    <!-- フローティングアクションボタン (FAB) -->
    <button onclick="addMember()" class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-xl z-40 transition transform hover:scale-110 active:scale-95 flex items-center justify-center md:hidden" aria-label="メンバーを追加">
        <i data-lucide="plus" class="w-8 h-8"></i>
    </button>

    <footer class="bg-gray-800 text-gray-400 py-6 text-center text-sm">
        <p>&copy; Multi Stopwatch App</p>
    </footer>

    <!-- カスタム確認モーダル -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden items-center justify-center p-4 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-100" id="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-2">確認</h3>
            <p id="modal-message" class="text-gray-600 mb-6">本当に実行しますか？</p>
            <div class="flex justify-end gap-3" id="modal-actions">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition">
                    キャンセル
                </button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded-lg font-medium shadow transition">
                    実行する
                </button>
            </div>
            <!-- OKボタンのみ（通知用） -->
            <div class="flex justify-end gap-3 hidden" id="modal-ok-only">
                <button onclick="closeModal()" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg font-medium shadow transition">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- テンプレート用スクリプト -->
    <script>
        // 状態管理
        let members = [];
        const maxMembers = 50; // 最大人数制限
        let pendingModalAction = null; // モーダルでの実行待ちアクション
        
        // 初期化
        window.onload = function() {
            // 入力欄の値を取得して初期化（デフォルト10）
            const initCount = parseInt(document.getElementById('init-count').value) || 10;
            initializeList(initCount, false);
            
            // アニメーションループ開始
            requestAnimationFrame(updateTimers);
        };

        // 人数指定で再生成
        function resetWithCount() {
            const countInput = document.getElementById('init-count');
            let count = parseInt(countInput.value);
            
            // バリデーション
            if (isNaN(count) || count < 1) count = 1;
            if (count > maxMembers) count = maxMembers;
            countInput.value = count;

            showModal("リストの再生成", `現在のデータをすべて削除し、${count}人で初期化しますか？`, () => {
                initializeList(count, true);
            });
        }

        // リスト初期化処理
        function initializeList(count, clearExisting) {
            // 既存データ削除
            if (clearExisting) {
                members = [];
                const grid = document.getElementById('members-grid');
                // 追加ボタン以外のカードを全て削除
                const cards = grid.querySelectorAll('.member-card:not(#add-card-btn)');
                cards.forEach(c => c.remove());
            }

            // 指定人数分追加
            for(let i = 1; i <= count; i++) {
                addMemberInternal(`メンバー ${i}`);
            }
            
            // アイコン更新
            lucide.createIcons();
        }

        // --- モーダル制御 ---
        function showModal(title, message, onConfirm = null, isAlert = false) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const overlay = document.getElementById('custom-modal');
            const actions = document.getElementById('modal-actions');
            const okOnly = document.getElementById('modal-ok-only');
            
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            
            // アニメーション用クラス
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
            }, 10);

            if (isAlert) {
                actions.classList.add('hidden');
                okOnly.classList.remove('hidden');
                pendingModalAction = null;
            } else {
                actions.classList.remove('hidden');
                okOnly.classList.add('hidden');
                pendingModalAction = onConfirm;
            }
        }

        function closeModal() {
            const overlay = document.getElementById('custom-modal');
            overlay.classList.add('opacity-0');
            setTimeout(() => {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
                pendingModalAction = null;
            }, 200);
        }

        // モーダルの実行ボタンに紐付け
        document.getElementById('modal-confirm-btn').onclick = function() {
            if (pendingModalAction) {
                pendingModalAction();
            }
            closeModal();
        };

        // メンバー追加処理
        function addMember() {
            if (members.length >= maxMembers) {
                showModal("制限", "これ以上メンバーを追加できません（最大50人まで）。", null, true);
                return;
            }
            const nextNum = members.length + 1;
            const newId = addMemberInternal(`メンバー ${nextNum}`);
            lucide.createIcons();
            
            // 追加した要素までスクロール＆ハイライト
            setTimeout(() => {
                const el = document.getElementById(`card-${newId}`);
                if(el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // ハイライトアニメーション
                    el.classList.add('ring-2', 'ring-blue-400', 'scale-[1.02]');
                    setTimeout(() => el.classList.remove('ring-2', 'ring-blue-400', 'scale-[1.02]'), 600);
                }
            }, 50);
        }

        // 内部用メンバー追加ロジック
        function addMemberInternal(name) {
            const id = Date.now() + Math.random().toString(36).substr(2, 9);
            const member = {
                id: id,
                name: name,
                startTime: 0,
                elapsedTime: 0,
                isRunning: false,
                finishedTime: null
            };
            members.push(member);
            renderMemberCard(member);
            return id;
        }

        // カードのHTML生成と挿入
        function renderMemberCard(member) {
            const grid = document.getElementById('members-grid');
            const addBtn = document.getElementById('add-card-btn'); // 追加ボタン要素
            
            const card = document.createElement('div');
            card.id = `card-${member.id}`;
            card.className = "member-card bg-white rounded-lg shadow border-l-4 border-gray-300 p-4 relative";
            
            card.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <input type="text" value="${member.name}" 
                        onchange="updateName('${member.id}', this.value)"
                        class="font-bold text-gray-700 bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none w-2/3 px-1 transition-colors">
                    <button onclick="removeMember('${member.id}')" class="text-gray-300 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition-colors" title="削除">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                
                <div class="flex justify-between items-end gap-2">
                    <div id="timer-${member.id}" class="timer-font text-4xl md:text-5xl font-bold text-gray-800 tracking-tight tabular-nums">
                        00:00.00
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2 mt-4">
                    <button id="btn-start-${member.id}" onclick="toggleTimer('${member.id}')" 
                        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded transition shadow-sm active:scale-95">
                        スタート
                    </button>
                    <button onclick="resetTimer('${member.id}')" 
                        class="bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-2 rounded transition shadow-sm active:scale-95">
                        リセット
                    </button>
                </div>
            `;
            
            // 追加ボタンの前に挿入する
            grid.insertBefore(card, addBtn);
        }

        // メンバー削除（スマートなアニメーション付き）
        function removeMember(id) {
            showModal("メンバーの削除", "このメンバーを削除しますか？", () => {
                const card = document.getElementById(`card-${id}`);
                if (card) {
                    // 削除アニメーション開始
                    card.classList.add('removing');
                    
                    // アニメーション完了後にデータを削除
                    setTimeout(() => {
                        const index = members.findIndex(m => m.id === id);
                        if (index > -1) {
                            members.splice(index, 1);
                            card.remove();
                        }
                    }, 300); // CSS transitionと合わせる
                }
            });
        }

        // 名前更新
        function updateName(id, newName) {
            const member = members.find(m => m.id === id);
            if(member) member.name = newName;
        }

        // 個別タイマー操作
        function toggleTimer(id) {
            const member = members.find(m => m.id === id);
            if (!member) return;

            const btn = document.getElementById(`btn-start-${id}`);
            const card = document.getElementById(`card-${id}`);

            if (member.isRunning) {
                // ストップ
                member.isRunning = false;
                member.elapsedTime = Date.now() - member.startTime;
                member.finishedTime = member.elapsedTime;
                
                btn.textContent = "再開";
                btn.className = "bg-orange-400 hover:bg-orange-500 text-white font-bold py-2 rounded transition shadow-sm active:scale-95";
                card.classList.remove("border-green-500");
                card.classList.add("border-blue-500");
            } else {
                // スタート
                member.startTime = Date.now() - member.elapsedTime;
                member.isRunning = true;
                member.finishedTime = null;
                
                btn.textContent = "ストップ";
                btn.className = "bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded transition shadow-sm active:scale-95";
                card.classList.remove("border-gray-300", "border-blue-500");
                card.classList.add("border-green-500");
            }
        }

        // 個別リセット
        function resetTimer(id) {
            const member = members.find(m => m.id === id);
            if (!member) return;

            member.isRunning = false;
            member.elapsedTime = 0;
            member.startTime = 0;
            member.finishedTime = null;

            document.getElementById(`timer-${id}`).textContent = "00:00.00";
            
            const btn = document.getElementById(`btn-start-${id}`);
            btn.textContent = "スタート";
            btn.className = "bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded transition shadow-sm active:scale-95";

            const card = document.getElementById(`card-${id}`);
            card.classList.remove("border-green-500", "border-blue-500");
            card.classList.add("border-gray-300");
        }

        // 全員スタート
        function startAll() {
            const now = Date.now();
            members.forEach(member => {
                if (!member.isRunning) {
                    member.isRunning = true;
                    member.startTime = now - member.elapsedTime;
                    member.finishedTime = null;

                    const btn = document.getElementById(`btn-start-${member.id}`);
                    if(btn) {
                        btn.textContent = "ストップ";
                        btn.className = "bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded transition shadow-sm active:scale-95";
                    }
                    const card = document.getElementById(`card-${member.id}`);
                    if(card) {
                        card.classList.remove("border-gray-300", "border-blue-500");
                        card.classList.add("border-green-500");
                    }
                }
            });
        }

        // 全員ストップ
        function stopAll() {
            const now = Date.now();
            members.forEach(member => {
                if (member.isRunning) {
                    member.isRunning = false;
                    member.elapsedTime = now - member.startTime;
                    member.finishedTime = member.elapsedTime;

                    const btn = document.getElementById(`btn-start-${member.id}`);
                    if(btn) {
                        btn.textContent = "再開";
                        btn.className = "bg-orange-400 hover:bg-orange-500 text-white font-bold py-2 rounded transition shadow-sm active:scale-95";
                    }
                    const card = document.getElementById(`card-${member.id}`);
                    if(card) {
                        card.classList.remove("border-green-500");
                        card.classList.add("border-blue-500");
                    }
                }
            });
        }

        // 全員リセット
        function resetAll() {
            showModal("全員リセット", "全員のタイムをリセットしますか？この操作は取り消せません。", () => {
                members.forEach(member => resetTimer(member.id));
            });
        }

        // 描画ループ
        function updateTimers() {
            const now = Date.now();
            members.forEach(member => {
                if (member.isRunning) {
                    const diff = now - member.startTime;
                    const el = document.getElementById(`timer-${member.id}`);
                    if(el) el.textContent = formatTime(diff);
                }
            });
            requestAnimationFrame(updateTimers);
        }

        // 時間フォーマット
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = Math.floor((ms % 1000) / 10);

            const mStr = String(minutes).padStart(2, '0');
            const sStr = String(seconds).padStart(2, '0');
            const msStr = String(milliseconds).padStart(2, '0');

            return `${mStr}:${sStr}.${msStr}`;
        }

        // レポート生成
        function generateReport() {
            const area = document.getElementById('report-area');
            const now = new Date();
            let text = `【計測結果】 ${now.toLocaleDateString()} ${now.toLocaleTimeString()}\n`;
            text += `--------------------------\n`;
            
            members.forEach((m, index) => {
                let timeStr = "--:--.--";
                let status = "待機中";
                
                if (m.finishedTime !== null) {
                    timeStr = formatTime(m.finishedTime);
                    status = "完了";
                } else if (m.isRunning) {
                    timeStr = formatTime(Date.now() - m.startTime);
                    status = "計測中";
                } else if (m.elapsedTime > 0) {
                     timeStr = formatTime(m.elapsedTime);
                     status = "一時停止";
                }

                text += `${String(index + 1).padStart(2, '0')}. ${m.name.padEnd(10, '　')}: ${timeStr} (${status})\n`;
            });
            
            area.value = text;
        }

        // コピー機能
        function copyReport() {
            const area = document.getElementById('report-area');
            if (!area.value) generateReport();
            
            area.select();
            document.execCommand('copy');
            
            const msg = document.getElementById('copy-message');
            msg.textContent = "コピーしました！";
            msg.classList.remove('opacity-0');
            setTimeout(() => {
                msg.classList.add('opacity-0');
            }, 2000);
        }
    </script>
</body>
</html>
